import{_ as o,K as s,o as n,c as l,O as i,k as e,a as d,$ as r}from"./chunks/framework.9fa1e75e.js";const D=JSON.parse('{"title":"@apostrophecms/widget-type","description":"","frontmatter":{"extends":"@apostrophecms/module"},"headers":[],"relativePath":"reference/modules/widget-type.md","filePath":"reference/modules/widget-type.md","lastUpdated":1690289066000}'),p={name:"reference/modules/widget-type.md"},c=e("h1",{id:"apostrophecms-widget-type",tabindex:"-1"},[e("code",null,"@apostrophecms/widget-type"),d(),e("a",{class:"header-anchor",href:"#apostrophecms-widget-type","aria-label":'Permalink to "`@apostrophecms/widget-type`"'},"​")],-1),h=r('<p>This module is the foundation for all widget types in Apostrophe, including the <a href="./../../guide/core-widgets.html">core widgets</a> as well as <a href="./../../guide/custom-widgets.html">custom widgets</a>. It is not typically configured or referenced in project code directly since each widget type should be managed independently in most cases. For example, the options documented below would be configured on a custom widget type, e.g., <code>article-widget</code>, rather this widget type base module.</p><p>The only reason to configure this module directly would be to apply the changes to <em>every</em> widget type, including those in Apostrophe core (e.g., <code>@apostrophecms/image-widget</code>).</p><h2 id="options" tabindex="-1">Options <a class="header-anchor" href="#options" aria-label="Permalink to &quot;Options&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>These are options to <em>the module itself</em>, so they apply to <em>every</em> instance of the widget. They are separate from the options that can be passed when adding the widget to an area field, and from the template options that be passed via the <code>with</code> keyword when inserting an area in a template.</p></div><table><thead><tr><th>Property</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><a href="#classname"><code>className</code></a></td><td>String</td><td>Core widgets apply it to themselves if set.</td></tr><tr><td><a href="#components"><code>components</code></a></td><td>Object</td><td>Vue components to be used when editing.</td></tr><tr><td><a href="#contextual"><code>contextual</code></a></td><td>Boolean</td><td>The widget is edited directly on the page, not in a modal.</td></tr><tr><td><a href="#defaultdata"><code>defaultData</code></a></td><td>Any</td><td>Default value of a contextual widget.</td></tr><tr><td><a href="#deferred"><code>deferred</code></a></td><td>Boolean</td><td>This widget type should load last.</td></tr><tr><td><a href="#icon"><code>icon</code></a></td><td>String</td><td>Icon name.</td></tr><tr><td><a href="#initialmodal"><code>initialModal</code></a></td><td>Boolean</td><td>Determine whether to display modal when added to page.</td></tr><tr><td><a href="#label"><code>label</code></a></td><td>String</td><td>Identifies this widget in a list of widget types.</td></tr><tr><td><a href="#neverload"><code>neverLoad</code></a></td><td>Array</td><td>Widget types never loaded recursively by this widget.</td></tr><tr><td><a href="#neverloadself"><code>neverLoadSelf</code></a></td><td>Boolean</td><td>The widget should never recursively load itself.</td></tr><tr><td><a href="#scene"><code>scene</code></a></td><td>String</td><td><strong>Deprecated.</strong> Can specify that this widget type requires logged-in assets.</td></tr><tr><td><a href="#template"><code>template</code></a></td><td>String</td><td>The Nunjucks template name to render.</td></tr></tbody></table><h3 id="classname" tabindex="-1"><code>className</code> <a class="header-anchor" href="#classname" aria-label="Permalink to &quot;`className`&quot;">​</a></h3><p>All of the core widget type modules of Apostrophe, such as <code>@apostrophecms/image</code>, will apply the class name set by this option to their outer wrapper element if configured for that widget type module and not overridden when the widget is configured as part of an area. Since Apostrophe is unopinionated on the front end, there is no default value.</p><p>Custom widgets have no default template, but may choose to support the same pattern:</p><div class="language-njk"><button title="Copy Code" class="copy"></button><span class="lang">njk</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">{# in a custom widget.html file #}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#A6ACCD;">{% if data.options.className %}</span></span>\n<span class="line"><span style="color:#A6ACCD;">  {% set className = data.options.className %}</span></span>\n<span class="line"><span style="color:#A6ACCD;">{% elif data.manager.options.className %}</span></span>\n<span class="line"><span style="color:#A6ACCD;">  {% set className = data.manager.options.className %}</span></span>\n<span class="line"><span style="color:#A6ACCD;">{% endif %}</span></span>\n<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">{%</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">if</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">className</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">%}</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">class</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">{{ className }}</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">{%</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">endif</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">%}</span><span style="color:#89DDFF;">&gt;</span></span>\n<span class="line"><span style="color:#A6ACCD;">  ...</span></span>\n<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div><h3 id="components" tabindex="-1"><code>components</code> <a class="header-anchor" href="#components" aria-label="Permalink to &quot;`components`&quot;">​</a></h3><p>If present, the <code>components</code> option must be an object and is consulted to determine the name of the Vue component to be used for editing, via its <code>widgetEditor</code> subproperty. If the <code>contextual</code> option is set to <code>true</code>, then the component must implement the <a href="./../../guide/editing-custom-widgets-in-context.html">contextual editing pattern</a>. Otherwise it must implement a modal dialog box implementing the same pattern as the standard widget editor dialog box (the <code>AposWidgetEditor</code> Vue component), which is usually not necessary as it is simpler to add existing and custom schema fields to be displayed by the existing dialog box.</p><h3 id="contextual" tabindex="-1"><code>contextual</code> <a class="header-anchor" href="#contextual" aria-label="Permalink to &quot;`contextual`&quot;">​</a></h3><p>When the <code>contextual</code> option is set to <code>true</code>, an edit button is not displayed for the widget, and the widget is not edited in a dialog box according to a schema of fields. Instead, the widget is edited directly on the page.</p><p>To support this, the widget must implement the <a href="./../../guide/editing-custom-widgets-in-context.html">contextual editing pattern</a>.</p><p>Defaults to <code>false</code>.</p><h3 id="defaultdata" tabindex="-1"><code>defaultData</code> <a class="header-anchor" href="#defaultdata" aria-label="Permalink to &quot;`defaultData`&quot;">​</a></h3><p>The <code>defaultData</code> option may contain an object providing defaults for contextually edited widgets. This is required for contextually edited widgets because they do not always use the <code>fields</code> section. Normal widgets that use the usual dialog box to edit schema fields may rely on the <code>def</code> property of each field instead. There is no default value.</p><h3 id="deferred" tabindex="-1"><code>deferred</code> <a class="header-anchor" href="#deferred" aria-label="Permalink to &quot;`deferred`&quot;">​</a></h3><p>Widget types may contain <code>relationship</code> and <code>relationshipReverse</code> fields that load other documents. By default this is done in the order the widgets are encountered when loading the page, with requests relating to the same type of widget grouped together for performance. This is a recursive process. Widget types that specify <code>deferred: true</code> will resolve their &quot;loaders&quot; at the very end of the process, after all other widget types and their relationships have been recursively loaded. This is beneficial for widget type modules like <code>@apostrophecms/image-widget</code> because they can be efficiently grouped together in a single database call. Defaults to <code>false</code>.</p><h3 id="icon" tabindex="-1"><code>icon</code> <a class="header-anchor" href="#icon" aria-label="Permalink to &quot;`icon`&quot;">​</a></h3><p>The name of the icon to be displayed for this widget type in a menu of widget types. This icon name must correspond to an icon loaded via <a href="/reference/module-api/module-overview.html#icons">the <code>icons</code> module section</a>. If not configured the widget type is listed without an icon.</p><h3 id="initialmodal" tabindex="-1"><code>initialModal</code> <a class="header-anchor" href="#initialmodal" aria-label="Permalink to &quot;`initialModal`&quot;">​</a></h3><p>The <code>initialModal</code> option is set to <code>true</code> by default. If set to <code>false</code>, it will prevent the initial modal from opening when a widget is added to the area.</p><h3 id="label" tabindex="-1"><code>label</code> <a class="header-anchor" href="#label" aria-label="Permalink to &quot;`label`&quot;">​</a></h3><p>The label to be displayed for the icon in a menu of widget types and in certain other contexts in the UI. This should be brief but informative and should be capitalized, like <code>Slideshow</code>. By default it is derived from the module name, but we recommend configuring an explicit label.</p><h3 id="neverload" tabindex="-1"><code>neverLoad</code> <a class="header-anchor" href="#neverload" aria-label="Permalink to &quot;`neverLoad`&quot;">​</a></h3><p>This option specifies an array of widget types that should never be loaded recursively by this widget type. While documents that contain those widget types might be loaded by relationships, additional relationships within those widget types will not be loaded. This can be a helpful guard against runaway recursion and the associated performance hit. There is no default because the default setting of <a href="#never-load-self"><code>neverLoadSelf</code></a> solves the runaway recursion problem for most widgets. However this option can further improve performance if certain widget types have relationships of their own, might be present via relationships specified for this widget, and are not necessary to present this widget.</p><h3 id="neverloadself" tabindex="-1"><code>neverLoadSelf</code> <a class="header-anchor" href="#neverloadself" aria-label="Permalink to &quot;`neverLoadSelf`&quot;">​</a></h3><p>If this option is set to <code>true</code>, and the widget has relationships with documents that contain more widgets of the <strong>same</strong> type, those widgets will <strong>not</strong> load their own relationships. This option defaults to <code>true</code>, which is an effective guard against runaway recursion and performance problems. Disabling this option should be done with care to ensure infinite loops do not become possible when loading the page.</p><h3 id="scene" tabindex="-1"><code>scene</code> <a class="header-anchor" href="#scene" aria-label="Permalink to &quot;`scene`&quot;">​</a></h3><p><strong>Deprecated.</strong> If this option is set to <code>user</code>, Apostrophe will load all of the JavaScript associated with the logged-in editing experience when this widget type is present. Since the admin UI is primarily designed for editors and not for the fast page load time, we do not recommend this approach and may remove this option in a future release of ApostropheCMS. By default this option is not set.</p><h3 id="template" tabindex="-1"><code>template</code> <a class="header-anchor" href="#template" aria-label="Permalink to &quot;`template`&quot;">​</a></h3><p>The name of the template in the <code>views</code> folder of the module that should be rendered to display the widget. This option defaults to <code>widget</code>, and it is generally not necessary to change it.</p><h2 id="related-documentation" tabindex="-1">Related documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related documentation&quot;">​</a></h2><ul><li><a href="/guide/core-widgets.html">Core widgets</a></li><li><a href="/guide/custom-widgets.html">Custom widgets</a></li></ul><h2 id="featured-methods" tabindex="-1">Featured methods <a class="header-anchor" href="#featured-methods" aria-label="Permalink to &quot;Featured methods&quot;">​</a></h2><h3 id="getbrowserdata-req" tabindex="-1"><code>getBrowserData(req)</code> <a class="header-anchor" href="#getbrowserdata-req" aria-label="Permalink to &quot;`getBrowserData(req)`&quot;">​</a></h3><p>This method returns an object of properties to be exposed on the browser side. If the module name is <code>hero-widget</code>, then this data is exposed as <code>window.apos.modules[&#39;hero-widget&#39;]</code>.</p><p>Since the default implementation exposes essential information, always use <code>extendMethods</code> to extend it, like this:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">extendMethods</span><span style="color:#A6ACCD;">(self) </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">    getBrowserData</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">_super</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">...</span><span style="color:#82AAFF;">_super</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">req</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>\n<span class="line"><span style="color:#F07178;">        newProperty</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span></span>\n<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">};</span></span>\n<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">};</span></span>\n<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h3 id="async-output-req-widget-options-with" tabindex="-1"><code>async output(req, widget, options, _with)</code> <a class="header-anchor" href="#async-output-req-widget-options-with" aria-label="Permalink to &quot;`async output(req, widget, options, _with)`&quot;">​</a></h3><p>Apostrophe invokes this method to render the widget. In most cases it is best to provide a <code>widget.html</code> template and rely on the default implementation of this method. However it is possible to override this method to render a widget in an entirely different way. The method must return a string of markup already marked as safe. If a custom implementation does not use Nunjucks then it may be returned as safe with the following code:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">template</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">safe</span><span style="color:#A6ACCD;">(string)</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>The <code>widget</code> argument contains the widget object with its schema fields, the <code>options</code> argument contains any options configured for this widget in the relevant <code>area</code> field, and the <code>_with</code> argument contains any template-level options passed via the <code>with</code> keyword.</p><h3 id="addsearchtexts-widget-texts" tabindex="-1"><code>addSearchTexts(widget, texts)</code> <a class="header-anchor" href="#addsearchtexts-widget-texts" aria-label="Permalink to &quot;`addSearchTexts(widget, texts)`&quot;">​</a></h3><p>This method is called to make the text of the widget available to Apostrophe&#39;s built-in search features. If the widget relies on schema fields for its content then it should not be necessary to override this method. However widget type modules like <code>@apostrophecms/rich-text-widget</code> that do not use fields will need to provide their own implementation, like this:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">methods</span><span style="color:#A6ACCD;">(self) </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">    addSearchTexts</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">item</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">texts</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">texts</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>\n<span class="line"><span style="color:#F07178;">        weight</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span></span>\n<span class="line"><span style="color:#F07178;">        text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">util</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">htmlToPlaintext</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">content</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>\n<span class="line"><span style="color:#F07178;">        silent</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>\n<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>\n<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>\n<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">};</span></span>\n<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>Currently texts with weights greater than <code>10</code> are available as part of <code>autocomplete</code> search, which affects the &quot;Manage Pieces&quot; dialog box. Texts marked <code>silent</code> impact search results but are not included in the <code>searchSummary</code> property of the overall document.</p><h3 id="sanitize-req-input-options" tabindex="-1"><code>sanitize(req, input, options)</code> <a class="header-anchor" href="#sanitize-req-input-options" aria-label="Permalink to &quot;`sanitize(req, input, options)`&quot;">​</a></h3><p>When the user edits a widget and the browser attempts to save that change, Apostrophe invokes this method to sanitize the user input. If the widget relies on schema fields, it is usually not necessary to override this method. It is most often overridden in modules like <code>@apostrophecms/rich-text-widget</code> that have special needs like sanitizing HTML markup. This method receives the Express request (<code>req</code>), an object representing a new value for the widget which contains untrusted data from the user (<code>input</code>), and the options configured for this widget type in the relevant <code>area</code> field (<code>options</code>). The return value must be an object and is stored as the new value of the widget, along with certain automatically-supplied properties like <code>type</code> and <code>_id</code> that this method does not need to concern itself with.</p><h3 id="load-req-widgets" tabindex="-1"><code>load(req, widgets)</code> <a class="header-anchor" href="#load-req-widgets" aria-label="Permalink to &quot;`load(req, widgets)`&quot;">​</a></h3><p>Apostrophe invokes this method to load any relationships defined in the schema fields of the widget. To create an opportunity for optimizations, the method is passed an array which may contain any number of widgets of this module&#39;s type.</p><p>Those choosing to override the method to perform additional loading of another kind should consider using <code>extendMethods</code> to invoke the original as well, unless <code>relationship</code> and <code>relationshipReverse</code> schema fields are guaranteed not to be present.</p><p>Custom reimplementations that do not have any special optimizations for more than one widget in the array must still take care to loop over <code>widgets</code> and load appropriate data for all of them.</p><p>There is no return value. The related documents are attached to the widget objects via temporary properties (properties whose names start with <code>_</code>, which tells Apostrophe that they should not be stored back to the database at save time).</p><p>As an alternative, consider invoking <a href="./../../guide/async-components.html">async components</a> from <code>widget.html</code>. Async components are easier to understand and will run only if the template elects to call them in a particular case, which can sometimes be more efficient.</p><h2 id="module-tasks" tabindex="-1">Module tasks <a class="header-anchor" href="#module-tasks" aria-label="Permalink to &quot;Module tasks&quot;">​</a></h2><h3 id="list" tabindex="-1"><code>list</code> <a class="header-anchor" href="#list" aria-label="Permalink to &quot;`list`&quot;">​</a></h3><p>Full command: <code>node app [widget-type-module-name]:list</code></p><p>This task generates a list of documents that contain the widget type in question, along with a &quot;dot path&quot; to the widget within the document. It is intended as a debugging tool. For instance:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">app</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">@apostrophecms/rich-text-widget:list</span></span></code></pre></div><p>Will list all of the rich text widgets on the site.</p>',62);function u(t,m,y,f,g,w){const a=s("AposRefExtends");return n(),l("div",null,[c,i(a,{module:t.$frontmatter.extends},null,8,["module"]),h])}const b=o(p,[["render",u]]);export{D as __pageData,b as default};
