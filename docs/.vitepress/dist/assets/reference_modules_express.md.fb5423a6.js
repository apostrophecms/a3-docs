import{_ as c,K as o,o as i,c as d,O as t,w as a,k as e,a as s,$ as n}from"./chunks/framework.9fa1e75e.js";const v=JSON.parse('{"title":"@apostrophecms/express","description":"","frontmatter":{"extends":"@apostrophecms/module"},"headers":[],"relativePath":"reference/modules/express.md","filePath":"reference/modules/express.md","lastUpdated":1690289066000}'),h={name:"reference/modules/express.md"},u=e("h1",{id:"apostrophecms-express",tabindex:"-1"},[e("code",null,"@apostrophecms/express"),s(),e("a",{class:"header-anchor",href:"#apostrophecms-express","aria-label":'Permalink to "`@apostrophecms/express`"'},"​")],-1),m=n(`<p>This module initializes the Express framework, which Apostrophe uses and extends to implement both API routes and page-serving routes. The Express <code>app</code> object is made available as <code>apos.app</code>, and the <code>express</code> object itself as <code>apos.express</code>. This module also adds a number of standard middleware functions and implements the server side of CSRF protection for Apostrophe.</p><h2 id="options" tabindex="-1">Options <a class="header-anchor" href="#options" aria-label="Permalink to &quot;Options&quot;">​</a></h2><table><thead><tr><th>Property</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>address</code></td><td>String</td><td>Apostrophe listens for connections on all interfaces (<code>0.0.0.0</code>) unless this option is set to another address. If the <code>ADDRESS</code> environment variable is set, it is used instead.</td></tr><tr><td><code>apiKeys</code></td><td>Object</td><td>Configure API keys for request authentication. See <a href="/reference/api/authentication.html#api-keys">the authentication guide</a> for more.</td></tr><tr><td><code>bodyParser</code></td><td>Object</td><td>The <code>json</code> and <code>urlencoded</code> properties of this object are merged with Apostrophe&#39;s default options to be passed to the <a href="https://www.npmjs.com/package/body-parser" target="_blank" rel="noreferrer"><code>body-parser</code> npm module&#39;s</a> <code>json</code> and <code>urlencoded</code> methods.</td></tr><tr><td><code>csrf</code></td><td>Boolean/Object</td><td>Set to <code>false</code> to disable CSRF protection or to an object with a <code>name</code> property to customize the CSRF cookie name. See below.</td></tr><tr><td><code>expressBearerToken</code></td><td>Object</td><td>An options object passed to <a href="https://www.npmjs.com/package/express-bearer-token" target="_blank" rel="noreferrer"><code>express-bearer-token</code></a> for the bearer token middleware.</td></tr><tr><td><code>port</code></td><td>Integer</td><td>Apostrophe listens for connections on port <code>3000</code> unless this option is set to another port. If the <code>PORT</code> environment variable is set, it is used instead.</td></tr><tr><td><code>session</code></td><td>Object</td><td>Properties of the <code>session</code> option are used to create the session middleware. See below.</td></tr><tr><td><code>trustProxy</code></td><td>Boolean</td><td>Enables the <a href="https://expressjs.com/en/api.html#trust.proxy.options.table" target="_blank" rel="noreferrer">trust proxy option for Express</a>. Set to <code>true</code> to tell the Express app to respect <code>X-Forwarded-* </code> headers. This is helpful when Apostrophe is generating <code>http:</code> URLs even though a proxy like nginx is being used to serve it over <code>https:</code>.</td></tr><tr><td><code>enableCacheOnDemand</code></td><td>Boolean</td><td>Set to <code>false</code> to disable cache on demand. <a href="/guide/caching.html#express-cache-on-demand">See documentation</a>.</td></tr></tbody></table><h3 id="session" tabindex="-1"><code>session</code> <a class="header-anchor" href="#session" aria-label="Permalink to &quot;\`session\`&quot;">​</a></h3><p>The <code>session</code> options object is passed to the <a href="https://npmjs.org/package/express-session" target="_blank" rel="noreferrer">express-session</a> function. If each is not otherwise specified, Apostrophe enables the following defaults:</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// Does not save sessions until something is stored in them. This greatly</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// reduces \`aposSessions\` collection size.</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">saveUninitialized</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// We are using the 3.x mongo store which is compatible with the</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// \`resave: false\` option, preventing the vast majority of session-related</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// race conditions.</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">resave</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// Always update the cookie, so that each successive access revives your</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// login session timeout.</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">rolling</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// This option should be customized in every project.</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">secret</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">you should have a secret</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">name</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">shortName</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.sid</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">cookie</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>By default Apostrophe stores sessions in MongoDB so it is not necessary to install another solution. If you want to use another session store, you can pass an instance as the store sub-option, but it&#39;s easier to let Apostrophe do the work of setting it up:</p>`,7),f=n('<p>Be sure to install <code>connect-redis</code>, or the store of your choice, as an npm dependency of your project.</p><h3 id="csrf" tabindex="-1"><code>csrf</code> <a class="header-anchor" href="#csrf" aria-label="Permalink to &quot;`csrf`&quot;">​</a></h3><p>By default, Apostrophe implements <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_blank" rel="noreferrer">CSRF protection</a> via an <code>XSRF-TOKEN</code> cookie. All non-safe HTTP requests (not <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code> or <code>TRACE</code>) automatically receive protection via CSRF middleware, which rejects requests in which the CSRF token does not match the header. <em>If the request was made with a valid API key or bearer token it bypasses this check.</em></p><p>If the <code>csrf</code> option is set to <code>false</code>, CSRF protection is disabled. <strong>This is not recommended.</strong> Set this option to an object with a <code>name</code> property to set that property&#39;s value as the CSRF cookie name.</p><p>You can configure exceptions to CSRF protection by setting the <a href="/reference/module-api/module-options.html#csrfexceptions"><code>csrfExceptions</code> option</a> of any module to an array of route names specific to that module, or URLs (starting with <code>/</code>). Exceptions may use <a href="https://github.com/isaacs/minimatch" target="_blank" rel="noreferrer">Minimatch</a> wildcards (<code>*</code> and <code>**</code>).</p><p>You may need to use this feature when implementing <code>POST</code> form submissions that do not send the header.</p><h2 id="environment-variables" tabindex="-1">Environment variables <a class="header-anchor" href="#environment-variables" aria-label="Permalink to &quot;Environment variables&quot;">​</a></h2><h3 id="apos-log-all-routes" tabindex="-1"><code>APOS_LOG_ALL_ROUTES</code> <a class="header-anchor" href="#apos-log-all-routes" aria-label="Permalink to &quot;`APOS_LOG_ALL_ROUTES`&quot;">​</a></h3><p>If <code>APOS_LOG_ALL_ROUTES</code> is a nonempty string, Apostrophe will log the journey of each request through various middleware functions, often ending in a route. These messages appear on the server console. This is helpful when a URL does not seem to reach the intended <a href="./../module-api/module-overview.html#restapiroutes-self">API route</a>.</p><p>Note that not every request ends in a route, as it is possible for middleware to redirect a request or send a response on its own.</p><h2 id="related-documentation" tabindex="-1">Related documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related documentation&quot;">​</a></h2><ul><li><a href="/reference/module-api/module-overview.html#routes-self">Custom express routes</a></li><li><a href="/reference/api/authentication.html#api-keys">Authentication with API keys</a></li></ul><h2 id="featured-methods" tabindex="-1">Featured methods <a class="header-anchor" href="#featured-methods" aria-label="Permalink to &quot;Featured methods&quot;">​</a></h2><p>This module&#39;s methods are used to generate the Express app. Customization should be done using the options described above. See the <a href="https://github.com/apostrophecms/apostrophe/blob/main/modules/%40apostrophecms/express/index.js" target="_blank" rel="noreferrer">source code</a> for all methods that belong to this module.</p>',14);function y(r,F,b,D,_,g){const p=o("AposRefExtends"),l=o("AposCodeBlock");return i(),d("div",null,[u,t(p,{module:r.$frontmatter.extends},null,8,["module"]),m,t(l,null,{caption:a(()=>[s(" modules/@apostrophecms/express/index.js ")]),default:a(()=>[s(" ```javascript module.exports = { options: { session: { store: { name: 'connect-redis', options: { // redis-specific options here } } } } } ``` ")]),_:1}),f])}const A=c(h,[["render",y]]);export{v as __pageData,A as default};
