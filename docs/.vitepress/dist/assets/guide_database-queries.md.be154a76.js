import{_ as l,K as c,o as p,c as r,O as t,w as o,k as e,$ as n,a as s}from"./chunks/framework.9fa1e75e.js";const j=JSON.parse('{"title":"Querying the database","description":"","frontmatter":{"prev":{"text":"Caching","link":"guide/caching.md"},"next":{"text":"Inserting and updating docs","link":"guide/database-insert-update.md"}},"headers":[],"relativePath":"guide/database-queries.md","filePath":"guide/database-queries.md","lastUpdated":1690289066000}'),i={name:"guide/database-queries.md"},d=n('<h1 id="querying-the-database" tabindex="-1">Querying the database <a class="header-anchor" href="#querying-the-database" aria-label="Permalink to &quot;Querying the database&quot;">â€‹</a></h1><p>When designing custom modules or customizing existing modules, it can quickly become necessary to fetch data that Apostrophe does not automatically make available. We might want to display a random image in a page banner or a few dynamically-chosen articles related to the page a visitor is on. Apostrophe has an API designed to help developers get as creative as they need to be.</p><p>One goal of the Apostrophe content query API is to facilitate common and advanced requests to the MongoDB database <em>without</em> requiring developers to know advanced MongoDB syntax. Understanding that low-level syntax will be helpful at times, but advanced knowledge should not be necessary.</p><p>This API also provides a layer of security. Queries made through Apostrophe (that maintain the original <code>req</code> request), will only return content the active website user is allowed to see.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>We use the terms &quot;query&quot; and &quot;query builders&quot; here. For developers with advanced Apostrophe 2 experience, these are generally the same as the A2 concepts of &quot;cursors&quot; and &quot;cursor filters.&quot;</p></div><h2 id="initiating-the-database-query" tabindex="-1">Initiating the database query <a class="header-anchor" href="#initiating-the-database-query" aria-label="Permalink to &quot;Initiating the database query&quot;">â€‹</a></h2><p>The page module (<code>@apostrophecms/page</code>) and all modules that <em>extend</em> the piece type module (<code>@apostrophecms/piece-type</code>), the two big &quot;doc type&quot; categories, have access to <strong>a <code>find()</code> method</strong> that initiates a database query. Any query using a doc type module&#39;s <code>find</code> method will be limited to that module type. This means that we can know that calling <code>self.find()</code> in a <code>product</code> piece module will only return products.</p><p>The <code>find</code> method takes up to three arguments:</p><table><thead><tr><th>Argument</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>req</code></td><td>TRUE</td><td>The associated request object. Using a provided <code>req</code> object is important for maintaining user role permissions.</td></tr><tr><td><code>criteria</code></td><td>FALSE</td><td>A <a href="https://docs.mongodb.com/manual/tutorial/query-documents/" target="_blank" rel="noreferrer">MongoDB criteria object</a>. It is often as simple as properties that match schema field names assigned to the desired value.</td></tr><tr><td><code>options</code></td><td>FALSE</td><td>The options object is converted to matching <a href="#using-query-builders">query builders</a>. It is often easier to add query builders in the fluent interface described below.</td></tr></tbody></table><p>In the following example, we are writing the function that powers an <a href="/guide/async-components.html">async template component</a>. This hypothetical component would be passed the product <code>_id</code> property where it is shown as <code>productId</code>.</p>',10),y=e("div",{class:"language-javascript"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"javascript"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"module.exports"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"extend"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"@apostrophecms/piece-type"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},",")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"  "),e("span",{style:{color:"#676E95","font-style":"italic"}},"// ...")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"components"),e("span",{style:{color:"#89DDFF"}},"("),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"self"),e("span",{style:{color:"#89DDFF"}},")"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"    "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"      "),e("span",{style:{color:"#676E95","font-style":"italic"}},"// Returning the five most recently created products.")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"      "),e("span",{style:{color:"#C792EA"}},"async"),e("span",{style:{color:"#F07178"}}," latest"),e("span",{style:{color:"#89DDFF"}},"("),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"req"),e("span",{style:{color:"#89DDFF"}},","),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"data"),e("span",{style:{color:"#89DDFF"}},")"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"        "),e("span",{style:{color:"#676E95","font-style":"italic"}},"// ðŸ‘‡ Setting up our query criteria.")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#C792EA"}},"const"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"criteria"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"          _id"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{"),e("span",{style:{color:"#F07178"}}," $ne"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"data"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#A6ACCD"}},"productId"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"        "),e("span",{style:{color:"#676E95","font-style":"italic"}},"// ðŸ‘‡ The `find` method starting the query.")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#C792EA"}},"const"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"products"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"await"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"self"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"find"),e("span",{style:{color:"#F07178"}},"("),e("span",{style:{color:"#A6ACCD"}},"req"),e("span",{style:{color:"#89DDFF"}},","),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"criteria"),e("span",{style:{color:"#F07178"}},")")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"          "),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"sort"),e("span",{style:{color:"#F07178"}},"("),e("span",{style:{color:"#89DDFF"}},"{"),e("span",{style:{color:"#F07178"}}," createdAt"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"-"),e("span",{style:{color:"#F78C6C"}},"1"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"}"),e("span",{style:{color:"#F07178"}},")")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"          "),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"limit"),e("span",{style:{color:"#F07178"}},"("),e("span",{style:{color:"#F78C6C"}},"5"),e("span",{style:{color:"#F07178"}},")")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"          "),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"toArray"),e("span",{style:{color:"#F07178"}},"()"),e("span",{style:{color:"#89DDFF"}},";")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"products"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"      "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"    "),e("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"  "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"};")])])])],-1),u={class:"info custom-block"},h=e("p",{class:"custom-block-title"},"INFO",-1),D=e("p",null,"For context, this is what it would look like to invoke this async component in a product show page template:",-1),F=e("div",{class:"language-njk"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"njk"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"{% component 'product:latest' with { productId: data.piece._id } %}")])])])],-1),A=n(`<p><strong>What is happening here?</strong></p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">async </span><span style="color:#82AAFF;">latest</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><p>Component functions are provided a request object, <code>req</code>, usually from a website visitor visiting a page that uses the component. The function also receives <code>data</code>, which is a data object a developer included when using the component in a template. (See the <a href="/guide/async-components.html">async component guide</a>] for more on that feature.)</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> criteria </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">_id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">$ne</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">productId </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre></div><p>We are going to get the most recently added products, but it wouldn&#39;t help visitors to see the product they&#39;re already looking at in this group. Here we create a <code>criteria</code> object that uses the MongoDB query syntax to look for documents whose <code>_id</code> property is not equal to (<code>$ne</code>) the ID of the active product.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> criteria)</span></span></code></pre></div><p>We are in the <code>product</code> module, so by calling the <code>find</code> method from <code>self</code> (which is the <code>product</code> module itself), our results are automatically limited to products. That&#39;s why our <code>criteria</code> object does not need to include that limitation, which would otherwise look like <code>type: &#39;product&#39;</code>.</p><p>We pass in the <code>req</code> object we received from the component function parameters and the criteria object. In this case we are not including a third object for <code>options</code>.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>It&#39;s important to understand that the <code>find</code> method is not the end of the process. It is only the beginning, setting up a query that may be refined and then needs to be executed by a separate method. There is more on that below, but for now make sure to understand that simply running <code>self.find()</code> by itself will not return any documents.</p></div><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">createdAt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">limit</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>These are <strong>query builders</strong>. Let&#39;s look at what query builders are before we identify what is happening in this example.</p><h2 id="using-query-builders" tabindex="-1">Using query builders <a class="header-anchor" href="#using-query-builders" aria-label="Permalink to &quot;Using query builders&quot;">â€‹</a></h2><p>Query builders are additional instructions added to the database query. These special methods may receive arguments, but many apply an effect without any arguments. They can be chained on a query, meaning that we can add multiple builders onto a query and each one will build on the rules established before it.</p><p>Examples of query builders include:</p><ul><li><code>.limit(10)</code>: This limits the number of results that the query will return to the number we pass it.</li><li><code>.sort({ name: 1 })</code>: This builder sorts query results based on a document property value. This one sorts by the <code>name</code> property in ascending order.</li><li><code>.search(&#39;search term&#39;)</code>: This accepts a string and looks for documents that have that string in Apostrophe&#39;s full-text index.</li><li><code>.relationships(false)</code>: This builder accepts <code>false</code> or an array of relationship field names to avoid or limit relationship data loading onto the request response (saving some processing when it&#39;s not needed).</li><li><code>.areas(false)</code>: Similarly, this builder accepts <code>false</code> to prevent fetching relationships and doing similar work for any widgets nested in the documents, which can also help with performance where that information is unnecessary. You can also specify an array of specific area names whose widgets should be fully loaded.</li></ul><p>As we can see here, query builders apply a wide variety of effects. See the <a href="/reference/query-builders.html">query builder reference page</a> for a full list of query builders and how to use them.</p><p>Let&#39;s take another look at the builders in the example above.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> criteria)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">createdAt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">limit</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>This example is using two query builders, <code>sort</code> and <code>limit</code>. As described above, <code>sort({ createdAt: -1})</code> sorts the queried documents in descending order on their <code>createdAt</code> properties (most recent first). <code>limit(5)</code> then ensures the request will return no more than five documents.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Many aspects of querying the database are the same for both page and piece queries. One thing that is different are certain query builders that only apply to requests by the page module. These builders do things like update how results should include &quot;child&quot; or &quot;ancestor&quot; pages from the page hierarchy.</p><p>There is <a href="/reference/query-builders.html#page-document-query-builders">a section for these builders</a> in the reference page. There is a similar section with a builder that only works on <em>image</em> piece queries as well.</p></div><h3 id="projections-reducing-returned-document-data" tabindex="-1">Projections: Reducing returned document data <a class="header-anchor" href="#projections-reducing-returned-document-data" aria-label="Permalink to &quot;Projections: Reducing returned document data&quot;">â€‹</a></h3><p>One very useful query builder is <code>.project()</code>. We often know what specific data properties we want from a query and it is rarely <em>every single property</em>. By applying a query projection we reduce density of the data returned, making the response lighter, faster, and easier work with during development.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">query</span></span>
<span class="line"><span style="color:#A6ACCD;">  .project({</span></span>
<span class="line"><span style="color:#A6ACCD;">    title: 1,</span></span>
<span class="line"><span style="color:#A6ACCD;">    _url: 1,</span></span>
<span class="line"><span style="color:#A6ACCD;">    _author: 1,</span></span>
<span class="line"><span style="color:#A6ACCD;">    publishedAt: 1</span></span>
<span class="line"><span style="color:#A6ACCD;">  })</span></span></code></pre></div><p>The <code>project</code> builder is one that uses a MongoDB syntax. The object passed as an argument should include schema field names for the document type we&#39;re querying with each set to <code>1</code> or <code>true</code>. This tells the database that we only want these fields in each document we get back. In addition to simple fields, Apostrophe enhances <code>project</code> to handle relationship fields and the special property <code>_url</code>.</p><p>The <code>_id</code> property is always included no matter what projection is used.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>In Apostrophe 2 this builder was named <code>projection</code>.</p></div><h3 id="paginating-query-results" tabindex="-1">Paginating query results <a class="header-anchor" href="#paginating-query-results" aria-label="Permalink to &quot;Paginating query results&quot;">â€‹</a></h3><p>There are a few query builders that can work together to &quot;paginate&quot; query results. Sometimes that is better than receiving an unknown large number of results all at once.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">query</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">perPage</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">20</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">page</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>This example tells the query that its results should be returned in a group of no more than 20 (<code>.perPage(20)</code>) and that we want the second group of results based on the active sort order (<code>.page(2)</code>). These builders are used in the Apostrophe REST APIs and can be very helpful when dealing with large amounts of content. They use two other builders internally (<code>limit</code> and <code>skip</code>), but can be easier to use for common situations.</p><h3 id="schema-field-builders" tabindex="-1">Schema field builders <a class="header-anchor" href="#schema-field-builders" aria-label="Permalink to &quot;Schema field builders&quot;">â€‹</a></h3><p>Apostrophe automatically creates query builders for most <a href="/guide/content-schema.html">schema fields</a> configured on piece and page types. Passing a value into a schema field builder refines the query to fetch documents that have the provided value in the matching field.</p><p>For example, we might have a select field on a <code>product</code> piece type to identify a particular category:</p>`,33),C=e("div",{class:"language-javascript"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"javascript"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"module.exports"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"fields"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#F07178"}},"add"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"      "),e("span",{style:{color:"#676E95","font-style":"italic"}},"//...")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#F07178"}},"category"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"        "),e("span",{style:{color:"#F07178"}},"type"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"select"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},",")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"        "),e("span",{style:{color:"#F07178"}},"label"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"Product Line"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},",")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"        "),e("span",{style:{color:"#F07178"}},"choices"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," [")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"          "),e("span",{style:{color:"#89DDFF"}},"{"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F07178"}},"value"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"professional"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},","),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F07178"}},"label"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"Professional"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"},")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"          "),e("span",{style:{color:"#89DDFF"}},"{"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F07178"}},"value"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"hobbyist"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},","),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F07178"}},"label"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"Hobby"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"},")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"          "),e("span",{style:{color:"#89DDFF"}},"{"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F07178"}},"value"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"athletic"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},","),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#F07178"}},"label"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"Athletic"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"        ]")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"}")])])])],-1),m=n(`<p>We can query products matching a particular category:</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">query</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">category</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">athletic</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>The following field types get this query builder treatment:</p><ul><li><code>string</code></li><li><code>slug</code></li><li><code>boolean</code></li><li><code>checkboxes</code></li><li><code>select</code></li><li><code>radio</code></li><li><code>integer</code></li><li><code>float</code></li><li><code>url</code></li><li><code>date</code></li><li><code>relationship</code></li></ul><p><code>relationship</code> fields get special treatment with four query builders for each field. If the field name is <code>_products</code>, then:</p><ul><li><code>._products(product._id)</code> matches only documents related to the product with the provided <code>_id</code>. You can also pass an array of product IDs, in which case documents related to <em>at least one</em> of those products will match.</li><li><code>.products(product.slug)</code> (no leading <code>_</code>) is similar, but supports matching by the <code>slug</code> property. You can also pass an array of product slugs, in which case only documents related to <em>at least one</em> of those products will match.</li><li><code>._productsAnd([ _id1, _id2, _id3...])</code> matches only documents related to <em>all</em> of the specified product IDs (one relation is not enough).</li><li><code>.productsAnd([ slug1, slug2, slug3...])</code> (no leading <code>_</code>) matches only documents related to <em>all</em> of the specified product slugs (one relation is not enough).</li></ul><p><code>_id</code> properties are useful since they will never change, but slugs can be more readable (for humans) and are more typically used in URLs.</p><h3 id="adding-your-own-query-builders" tabindex="-1">Adding your own query builders <a class="header-anchor" href="#adding-your-own-query-builders" aria-label="Permalink to &quot;Adding your own query builders&quot;">â€‹</a></h3><p>We&#39;re not limited to the query builders that come in Apostrophe core. It may help to create a builder that applies certain criteria and other builders that we might otherwise have to write repeatedly across a code base.</p><p>We can do this with the <code>queries()</code> customization function in the module configuration API. See the <a href="/reference/module-api/module-overview.html#queries-self-query">module configuration API reference</a> for more information.</p><h2 id="finishing-with-query-methods" tabindex="-1">Finishing with query methods <a class="header-anchor" href="#finishing-with-query-methods" aria-label="Permalink to &quot;Finishing with query methods&quot;">â€‹</a></h2><p>Initiating a query with <code>find()</code> and adding query builders are how we set up our data request. To get results we can use, the query ends with a <strong>query method</strong>. The query method takes the criteria and refinement we set up and adds logic that tells the database how we want our information back.</p><p>The simplest and most commonly used query methods are <strong><code>toArray</code></strong> and <strong><code>toObject</code></strong>. They either return an array of document results or a single document result, respectively.</p><h3 id="toarray" tabindex="-1"><code>toArray</code> <a class="header-anchor" href="#toarray" aria-label="Permalink to &quot;\`toArray\`&quot;">â€‹</a></h3><p>Our query example from above uses <code>toArray()</code>. Let&#39;s look at that again.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> products </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> criteria)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">createdAt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">limit</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toArray</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>As we&#39;ve covered already, this code sets up the initial query with criteria (<code>self.find</code>) and adds builders with additional instructions (<code>sort</code> and <code>limit</code>). The final thing it does is run <code>toArray()</code> on the query. This is telling the database, &quot;take all the instructions we provided and give us back an array of results based on those instructions. Please.&quot; So, at the end of this, <code>products</code> will be an array of up to five document objects.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>See that in our example we use <code>await</code> before <code>self.find</code>, indicating that this is running an asynchronous operation. It is worth noting that <code>toArray()</code> is the only asynchronous part of the code since that&#39;s the part that actually talks to the database.</p><p>It is totally fine to set up queries synchronously (without <code>await</code>) and then execute the query in a separate step later.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> query </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> criteria)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">createdAt</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">limit</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> products </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> query</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toArray</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div></div><h3 id="toobject" tabindex="-1"><code>toObject</code> <a class="header-anchor" href="#toobject" aria-label="Permalink to &quot;\`toObject\`&quot;">â€‹</a></h3><p><code>toObject</code> is very similar to <code>toArray</code>, but it only returns one result as an object. In fact, <code>toObject</code> is basically the same as setting a <code>limit(1)</code> builder on the query then taking the single object out of the returned array. Using <code>toObject</code> simply makes it easier to write queries when we only want one result. For example, we may already know the unique <code>_id</code> of the document we want from the database.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> productId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ckcqi1ye1005mof3rdgtlln0b:en:published</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> product </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">_id</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> productId </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toObject</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="tocount" tabindex="-1"><code>toCount</code> <a class="header-anchor" href="#tocount" aria-label="Permalink to &quot;\`toCount\`&quot;">â€‹</a></h3><p>The <code>toCount</code> query method is the easiest and quickest way to simply get the number of documents that match a query. The <code>toCount</code> query method will ignore any <code>page</code>, <code>skip</code> and <code>limit</code> query builders in order to get the total number.</p><p>If the query is using a <code>perPage</code> query builder it will also populate <code>totalPages</code> on the query, which can be retrieved with <code>query.get(&#39;totalPages&#39;)</code>.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> productsCount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> criteria)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toCount</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="todistinct" tabindex="-1"><code>toDistinct</code> <a class="header-anchor" href="#todistinct" aria-label="Permalink to &quot;\`toDistinct\`&quot;">â€‹</a></h3><p><code>toDistinct</code> allows us to retrieve the unique values for a particular document property from the documents that match query. For example, using <code>query.toDistinct(&#39;category&#39;)</code> will return an array with all the <code>category</code> property values across documents, with each category only appearing once in the array.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> shoeColors </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">shoe</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toDistinct</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">color</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="tochoices" tabindex="-1"><code>toChoices</code> <a class="header-anchor" href="#tochoices" aria-label="Permalink to &quot;\`toChoices\`&quot;">â€‹</a></h3><p>The <code>toChoices</code> query method builds on <code>toDistinct</code> by returning each choice as an object with <code>label</code> and <code>value</code> properties. This can be useful when populating a select or other input field with options for a doc type property. For example, this is used for the document manager modal filter UI in Apostrophe.</p><p><code>toChoices</code> accepts an options object as an optional second argument. Setting <code>counts: true</code> in that options object will include a <code>count</code> property on each returned choice indicating how many documents match that choice.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> teamOffices </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">team</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toChoices</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">office</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">count</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h2 id="query-across-modules" tabindex="-1">Query across modules <a class="header-anchor" href="#query-across-modules" aria-label="Permalink to &quot;Query across modules&quot;">â€‹</a></h2><p>The <code>find()</code> method in doc type modules is easy to use within each module as <code>self.find</code>. However this assumes we&#39;re looking for only content that is governed by the module where the method is called. There are two main ways to write these database queries from one module and get content managed by a separate module.</p><h3 id="using-another-module-s-find-method" tabindex="-1">Using another module&#39;s <code>find</code> method <a class="header-anchor" href="#using-another-module-s-find-method" aria-label="Permalink to &quot;Using another module&#39;s \`find\` method&quot;">â€‹</a></h3><p>The <code>self</code> object available in any Apostrophe module&#39;s customization functions can access other doc types on the <code>self.apos.modules</code> object. For example, if I&#39;m working in the <code>article</code> module and want to query <code>author</code> pieces, I can access the <code>author</code> module with this:</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">modules</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">author</span></span></code></pre></div><p><code>self.apos.modules.author</code> is the same as <code>self</code> would be if we were operating within the <code>author</code> module. Therefore we can query author pieces directly by using that module&#39;s <code>find</code> method.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> activeAuthors </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">modules</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">author</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">active</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toArray</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>If a doc type module has been <a href="/reference/module-api/module-options.html#alias">assigned an alias</a>, then the doc type module will be directly on <code>self.apos</code>. For example, the <code>@apostrophecms/page</code> module is available as <code>self.apos.page</code> because <code>&#39;page&#39;</code> is its alias option value.</p><h3 id="querying-multiple-doc-types" tabindex="-1">Querying multiple doc types <a class="header-anchor" href="#querying-multiple-doc-types" aria-label="Permalink to &quot;Querying multiple doc types&quot;">â€‹</a></h3><p>As mentioned earlier, doc type modules&#39; <code>find</code> methods will automatically restrict results to that document type. Sometimes we may want to fetch documents that match a query regardless of what doc type they are (e.g., all content tagged with a certain term). Or we may use a querying function across contexts and we don&#39;t know what doc type we will be looking for.</p><p>There is a module that governs all content documents: <code>@apostrophecms/doc</code>, which is aliased as <code>&#39;doc&#39;</code>. Its <code>find</code> method works the same as any individual doc type&#39;s, but it is not restricted to any one document type. We can then use it to look for a particular type with the <code>type</code> property or pass it criteria and get documents of multiple types in the results.</p><div class="language-javascript"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> featuredContent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">doc</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">featured</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toArray</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> featuredByType </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">apos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">doc</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#A6ACCD;">(req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">featured</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> selectedType </span><span style="color:#676E95;font-style:italic;">// A hypothetical option a user selected.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toArray</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>Using <code>self.apos.doc.find</code> has limitations, however. Significantly, pieces will not return with <code>_url</code> properties. We would have to run additional queries to the individual piece type module <code>find</code> methods once we knew what types we had. That is one reason why using <code>self.find()</code> from doc type modules is better when possible.</p><h2 id="where-in-my-code-can-i-make-database-queries" tabindex="-1">Where in my code can I make database queries? <a class="header-anchor" href="#where-in-my-code-can-i-make-database-queries" aria-label="Permalink to &quot;Where in my code can I make database queries?&quot;">â€‹</a></h2><p>You can make database queries in async components (as shown above), routes (such as in an <a href="./../reference/module-api/module-overview.html#apiroutes-self"><code>apiRoutes</code></a> function), <a href="./server-events.html">server event handlers</a>, middleware and in pretty much any async function in your server-side code. However, you should avoid making database queries:</p><ul><li>In the <code>init()</code> function of a module, because schemas of other related types might not yet be finalized, leading to errors in relationship queries.</li><li>In an <code>apostrophe:modulesRegistered</code> server event handler, for the same reason.</li></ul><p>If you wish to make queries in your module at the time the process starts up (not on every request), writing a <code>@apostrophecms/doc:beforeReplicate</code> server event handler is the safest choice. If you are trying to make a query on every page request, you should write an async component, or write an <code>@apostrophecms/page:beforeSend</code> server event handler which will receive <code>(req)</code> as its first argument, giving you a way to attach the query results to <code>req.data</code> for use in the template.</p>`,49);function g(f,b,w,q,v,k){const a=c("AposCodeBlock");return p(),r("div",null,[d,t(a,null,{caption:o(()=>[s(" modules/product/index.js ")]),default:o(()=>[y,s()]),_:1}),e("div",u,[h,D,t(a,null,{caption:o(()=>[s(" modules/product-page/views/show.html ")]),default:o(()=>[F,s()]),_:1})]),A,t(a,null,{caption:o(()=>[s(" modules/product-page/views/show.html ")]),default:o(()=>[C,s()]),_:1}),m])}const T=l(i,[["render",g]]);export{j as __pageData,T as default};
