import{_ as l,a as r,b as i,c}from"./chunks/s3-object-permission.e43b300c.js";import{_ as p,K as d,o as h,c as u,O as t,w as s,$ as n,k as e,a as o}from"./chunks/framework.9fa1e75e.js";const M=JSON.parse('{"title":"Hosting an Apostrophe project with Docker","description":"","frontmatter":{},"headers":[],"relativePath":"cookbook/using-docker.md","filePath":"cookbook/using-docker.md","lastUpdated":1690289066000}'),y={name:"cookbook/using-docker.md"},C=n("",10),g=e("div",{class:"language-bash"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"FROM"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"node:lts-alpine3.15")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"WORKDIR"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/srv/www/apostrophe")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"RUN"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"chown"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"-R"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"node:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/srv/www/apostrophe")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"USER"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"node")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"COPY"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"--chown=node"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"package"),e("span",{style:{color:"#A6ACCD"}},"*"),e("span",{style:{color:"#C3E88D"}},".json"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/srv/www/apostrophe/")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"NODE_ENV"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#C3E88D"}},"production")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"RUN"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"npm"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"ci")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"COPY"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"--chown=node"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"."),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/srv/www/apostrophe/")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"RUN"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"./scripts/build-assets.sh")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"CMD"),e("span",{style:{color:"#A6ACCD"}}," ["),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"node"),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#A6ACCD"}},", "),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"app.js"),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"]")])])])],-1),m=n("",10),D=e("div",{class:"language-bash"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#676E95","font-style":"italic"}},"#!/bin/sh")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#C792EA"}},"export"),e("span",{style:{color:"#A6ACCD"}}," APOS_RELEASE_ID"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#89DDFF"}},"`"),e("span",{style:{color:"#FFCB6B"}},"cat"),e("span",{style:{color:"#C3E88D"}}," /dev/urandom "),e("span",{style:{color:"#89DDFF"}},"|"),e("span",{style:{color:"#FFCB6B"}},"env"),e("span",{style:{color:"#C3E88D"}}," LC_CTYPE=C tr -dc "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"a-zA-Z0-9"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}}," "),e("span",{style:{color:"#89DDFF"}},"|"),e("span",{style:{color:"#C3E88D"}}," "),e("span",{style:{color:"#FFCB6B"}},"fold"),e("span",{style:{color:"#C3E88D"}}," -w "),e("span",{style:{color:"#F78C6C"}},"32"),e("span",{style:{color:"#C3E88D"}}," "),e("span",{style:{color:"#89DDFF"}},"|"),e("span",{style:{color:"#C3E88D"}}," "),e("span",{style:{color:"#FFCB6B"}},"head"),e("span",{style:{color:"#C3E88D"}}," -n "),e("span",{style:{color:"#F78C6C"}},"1"),e("span",{style:{color:"#89DDFF"}},"`")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#82AAFF"}},"echo"),e("span",{style:{color:"#A6ACCD"}}," $APOS_RELEASE_ID "),e("span",{style:{color:"#89DDFF"}},">"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"./release-id")]),o(`
`),e("span",{class:"line"}),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"node"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"app"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"@apostrophecms/asset:build")])])])],-1),b=n("",4),f=e("div",{class:"language-bash"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},".vscode/")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"apos-build/")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"badges/")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"data/")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"node-modules/")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"public/uploads/")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},".dockerignore")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},".env")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},".eslintignore")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},".gitignore")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"deploy-test-count")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"docker-compose.yaml")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"dockerfile")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"force-deploy")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"local.example.js")])])])],-1),A=e("h3",{id:"creating-a-docker-compose-yaml-file",tabindex:"-1"},[o("Creating a "),e("code",null,"docker-compose.yaml"),o(" file "),e("a",{class:"header-anchor",href:"#creating-a-docker-compose-yaml-file","aria-label":'Permalink to "Creating a `docker-compose.yaml` file"'},"â€‹")],-1),w=e("p",null,[o("In this guide, we are starting by creating multiple containers and a persistent volume. This is so that we can provide both a MongoDB instance and a place to store uploaded assets. We are going to do this using "),e("a",{href:"https://docs.docker.com/compose/",target:"_blank",rel:"noreferrer"},"Docker Compose"),o(" and a "),e("code",null,"docker-compose.yml"),o(" file. In the following sections of the tutorial, we will look at removing the extra container and volume by taking advantage of cloud storage and database services. Create this file at the root of your project.")],-1),k=e("div",{class:"language-bash"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"services:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"db:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"image:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"mongo:4.4.14")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"ports:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"27018:27018"),e("span",{style:{color:"#89DDFF"}},'"')]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"volumes:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/data/db")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#FFCB6B"}},"web:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"build:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"context:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},".")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"container_name:"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"apostrophe-container"),e("span",{style:{color:"#89DDFF"}},'"')]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"ports:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"3000:3000"),e("span",{style:{color:"#89DDFF"}},'"')]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"environment:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"NODE_ENV")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_MONGODB_URI")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_CLUSTER_PROCESSES")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"depends_on:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"db"),e("span",{style:{color:"#A6ACCD"}}," ")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"volumes:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"/srv/www/apostrophe/public/uploads")])])])],-1),F=n("",11),_=e("div",{class:"language-bash"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"NODE_ENV"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#C3E88D"}},"production")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_MONGODB_URI"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#C3E88D"}},"mongodb://db:27018/apostrophe")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_CLUSTER_PROCESSES"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#F78C6C"}},"2")])])])],-1),v=n("",24),B=e("div",{class:"language-bash"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"â€¦")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#FFCB6B"}},"environment:")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"NODE_ENV")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_MONGODB_URI")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_CLUSTER_PROCESSES")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_S3_REGION")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_S3_BUCKET")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_S3_KEY")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"      "),e("span",{style:{color:"#FFCB6B"}},"-"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"APOS_S3_SECRET")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#FFCB6B"}},"â€¦")])])])],-1),E=e("h3",{id:"changing-the-env-file",tabindex:"-1"},[o("Changing the "),e("code",null,".env"),o(" file "),e("a",{class:"header-anchor",href:"#changing-the-env-file","aria-label":'Permalink to "Changing the `.env` file"'},"â€‹")],-1),S=e("p",null,[o("Next, the "),e("code",null,".env"),o(" file should be modified to contain values for each of the new environment variables. Each will get populated with values specific to your S3 buckets. Again, add the "),e("code",null,"APOS_S3_ENDPOINT"),o(" with value if using a service not hosted by AWS.")],-1),T=e("div",{class:"language-sh"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"sh"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"NODE_ENV"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#C3E88D"}},"production")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_MONGODB_URI"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#C3E88D"}},"mongodb://db:27018/apostrophe")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_S3_REGION"),e("span",{style:{color:"#89DDFF"}},"=<"),e("span",{style:{color:"#C3E88D"}},"your"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#FFCB6B"}},"region>")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_S3_BUCKET"),e("span",{style:{color:"#89DDFF"}},"=<"),e("span",{style:{color:"#C3E88D"}},"your"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#FFCB6B"}},"bucket"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#C3E88D"}},"nam"),e("span",{style:{color:"#A6ACCD"}},"e"),e("span",{style:{color:"#89DDFF"}},">")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_S3_KEY"),e("span",{style:{color:"#89DDFF"}},"=<"),e("span",{style:{color:"#C3E88D"}},"account"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#FFCB6B"}},"key>")]),o(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"APOS_S3_SECRET"),e("span",{style:{color:"#89DDFF"}},"=<"),e("span",{style:{color:"#C3E88D"}},"account"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#FFCB6B"}},"secret>")])])])],-1),P=n("",20);function O(j,q,x,I,N,R){const a=d("AposCodeBlock");return h(),u("div",null,[C,t(a,null,{caption:s(()=>[o(" Dockerfile ")]),default:s(()=>[g]),_:1}),m,t(a,null,{caption:s(()=>[o(" scripts/build-asset.sh ")]),default:s(()=>[D]),_:1}),b,t(a,null,{caption:s(()=>[o(" .dockerignore ")]),default:s(()=>[f]),_:1}),A,w,t(a,null,{caption:s(()=>[o(" docker-compose.yaml ")]),default:s(()=>[k]),_:1}),F,t(a,null,{caption:s(()=>[o(" .env ")]),default:s(()=>[_]),_:1}),v,t(a,null,{caption:s(()=>[o(" docker-compose.yaml ")]),default:s(()=>[B]),_:1}),E,S,t(a,null,{caption:s(()=>[o(" .env ")]),default:s(()=>[T]),_:1}),P])}const V=p(y,[["render",O]]);export{M as __pageData,V as default};
