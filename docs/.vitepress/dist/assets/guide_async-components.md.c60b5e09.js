import{_ as a,K as c,o as p,c as r,O as n,w as o,$ as l,k as e,a as s}from"./chunks/framework.9fa1e75e.js";const x=JSON.parse('{"title":"Async components","description":"","frontmatter":{"prev":{"text":"Template fragments","link":"guide/fragments.md"},"next":{"text":"User and User Roles","link":"/guide/users.md"}},"headers":[],"relativePath":"guide/async-components.md","filePath":"guide/async-components.md","lastUpdated":1690289066000}'),i={name:"guide/async-components.md"},d=l('<h1 id="async-components" tabindex="-1">Async components <a class="header-anchor" href="#async-components" aria-label="Permalink to &quot;Async components&quot;">​</a></h1><p>Writing template files is how we turn data into HTML to display in browsers (or any number of other interfaces). When the data we are using comes directly from <a href="/reference/field-types/index.html">standard document or widget fields</a>, normal templates already have it ready to use. But what if the data we want to display needs to be freshly queried from the database or fetched from a third-party source?</p><p><strong>Async components</strong> offer a great way to use data from asynchronous requests in templates. They also make it easy to <em>reuse</em> that template code. For developers familiar with the previous major version of Apostrophe, this replaces some clunkier and less clear ways to use async data in templates.</p><h2 id="using-async-components-in-templates" tabindex="-1">Using async components in templates <a class="header-anchor" href="#using-async-components-in-templates" aria-label="Permalink to &quot;Using async components in templates&quot;">​</a></h2><p>In the template, an async component looks like this:</p><div class="language-njk"><button title="Copy Code" class="copy"></button><span class="lang">njk</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">{% component &#39;product:newest&#39; with { max: 3 } %}</span></span></code></pre></div><ul><li>The <code>{% component %}</code> tag indicates that we are working with an async component.</li><li><code>&#39;product:newest&#39;</code> tells the template two things: <ol><li>The component is defined in the <code>product</code> module.</li><li>Its name is <code>newest</code>, which is used as the component function name as well as its template partial filename.</li></ol></li><li><code>with { max: 3 }</code> is an options object that will be passed to the component function. It&#39;s not required, but can allow for varied use in different contexts.</li></ul><p>With that one line, the template rendering will know to find the component definition, execute the component function asynchronously, and render the appropriate template partial. That&#39;s a lot of benefit for one line of template code.</p><p>Let&#39;s see how we define these components.</p><h2 id="defining-async-components" tabindex="-1">Defining async components <a class="header-anchor" href="#defining-async-components" aria-label="Permalink to &quot;Defining async components&quot;">​</a></h2><p>There are two parts to creating an async component. First, we need to write a component function in a module. Second, we add a template that uses the data returned by the function.</p><p>Async component functions are defined in a module&#39;s <code>components</code> customization function. Add a <code>components</code> function to a module that takes <code>self</code> (representing the module itself) as an argument. It must return an object containing the individual component functions.</p>',12),y=e("div",{class:"language-js"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"js"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"module.exports"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"extend"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"@apostrophecms/piece-type"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},",")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"components"),e("span",{style:{color:"#89DDFF"}},"("),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"self"),e("span",{style:{color:"#89DDFF"}},")"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"    "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"      "),e("span",{style:{color:"#676E95","font-style":"italic"}},"// Async component functions here...")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"    "),e("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"  "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"};")])])])],-1),F=l("<p>Each component function takes two arguments:</p><table><thead><tr><th>Argument</th><th>Description</th></tr></thead><tbody><tr><td><code>req</code></td><td>The request object from the originating template context.</td></tr><tr><td><code>data</code></td><td>Data passed into the component where the component is used. (<code>{ max: 3 }</code> in the example above)</td></tr></tbody></table><p><strong>The function should return an object</strong> that will be passed into its template as <code>data</code>. This best practice makes using the returned data consistent with other template data and thus clearer in the template partial.</p><p>For example, this component function in a <code>product</code> module requests products from the database in reverse chronological order and limits the number of products using <code>data.max</code>, if available. We then pass that to the template on the <code>products</code> property of our new data object.</p>",4),m=e("div",{class:"language-js"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"js"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"module.exports"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"extend"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#C3E88D"}},"@apostrophecms/piece-type"),e("span",{style:{color:"#89DDFF"}},"'"),e("span",{style:{color:"#89DDFF"}},",")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  "),e("span",{style:{color:"#F07178"}},"components"),e("span",{style:{color:"#89DDFF"}},"("),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"self"),e("span",{style:{color:"#89DDFF"}},")"),e("span",{style:{color:"#A6ACCD"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"    "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"      "),e("span",{style:{color:"#C792EA"}},"async"),e("span",{style:{color:"#F07178"}}," newest"),e("span",{style:{color:"#89DDFF"}},"("),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"req"),e("span",{style:{color:"#89DDFF"}},","),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD","font-style":"italic"}},"data"),e("span",{style:{color:"#89DDFF"}},")"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"        "),e("span",{style:{color:"#676E95","font-style":"italic"}},"// Using the `find` method with query builders")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#C792EA"}},"const"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"products"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"await"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#A6ACCD"}},"self"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"find"),e("span",{style:{color:"#F07178"}},"("),e("span",{style:{color:"#A6ACCD"}},"req"),e("span",{style:{color:"#F07178"}},")"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"sort"),e("span",{style:{color:"#F07178"}},"("),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"          createdAt"),e("span",{style:{color:"#89DDFF"}},":"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"-"),e("span",{style:{color:"#F78C6C"}},"1")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#89DDFF"}},"}"),e("span",{style:{color:"#F07178"}},")"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"limit"),e("span",{style:{color:"#F07178"}},"("),e("span",{style:{color:"#A6ACCD"}},"data"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#A6ACCD"}},"max"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"||"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#F78C6C"}},"5"),e("span",{style:{color:"#F07178"}},")"),e("span",{style:{color:"#89DDFF"}},"."),e("span",{style:{color:"#82AAFF"}},"toArray"),e("span",{style:{color:"#F07178"}},"()"),e("span",{style:{color:"#89DDFF"}},";")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),e("span",{style:{color:"#F07178"}}," "),e("span",{style:{color:"#89DDFF"}},"{")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"          "),e("span",{style:{color:"#A6ACCD"}},"products")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"        "),e("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"      "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"    "),e("span",{style:{color:"#89DDFF"}},"};")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#F07178"}},"  "),e("span",{style:{color:"#89DDFF"}},"}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"};")])])])],-1),D=e("p",null,[s("The database request is asynchronous (as you can tell since it is an "),e("code",null,"async"),s(" function and uses "),e("code",null,"await"),s(" while making the request). This is the kind of thing that would otherwise cause trouble for a template.")],-1),h=e("p",null,[s("Since the name of the component function is "),e("code",null,"newest"),s(", our template partial for it will be in the "),e("code",null,"product"),s(" module as "),e("code",null,"newest.html"),s(".")],-1),u=e("div",{class:"language-njk"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"njk"),e("pre",{class:"shiki material-theme-palenight"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"<"),e("span",{style:{color:"#F07178"}},"h2"),e("span",{style:{color:"#89DDFF"}},">"),e("span",{style:{color:"#A6ACCD"}},"Newest products"),e("span",{style:{color:"#89DDFF"}},"</"),e("span",{style:{color:"#F07178"}},"h2"),e("span",{style:{color:"#89DDFF"}},">")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"<"),e("span",{style:{color:"#F07178"}},"ul"),e("span",{style:{color:"#89DDFF"}},">")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  {% for product in data.products %}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"    "),e("span",{style:{color:"#89DDFF"}},"<"),e("span",{style:{color:"#F07178"}},"li"),e("span",{style:{color:"#89DDFF"}},"><"),e("span",{style:{color:"#F07178"}},"a"),e("span",{style:{color:"#89DDFF"}}," "),e("span",{style:{color:"#C792EA"}},"href"),e("span",{style:{color:"#89DDFF"}},"="),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#C3E88D"}},"{{ product._url }}"),e("span",{style:{color:"#89DDFF"}},'"'),e("span",{style:{color:"#89DDFF"}},">"),e("span",{style:{color:"#A6ACCD"}},"{{ product.title }}"),e("span",{style:{color:"#89DDFF"}},"</"),e("span",{style:{color:"#F07178"}},"li"),e("span",{style:{color:"#89DDFF"}},">")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#A6ACCD"}},"  {% endfor %}")]),s(`
`),e("span",{class:"line"},[e("span",{style:{color:"#89DDFF"}},"</"),e("span",{style:{color:"#F07178"}},"ul"),e("span",{style:{color:"#89DDFF"}},">")])])])],-1),f=l('<p><code>data.products</code> in this template is the information we returned in the component function. From there, this is a normal template. The resulting markup is rendered along with the original template that used the <code>{% component %}</code> tag.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Async components have many uses. One of the most common is to support reuse in different contexts. For instance, the home page may always use the <code>newest</code> component at a fixed point in the page template. A products widget might also use it to show the newest products anywhere editors want to show the information.</p><p>Inside Apostrophe, async components are used to implement the <code>{% area %}</code> tag.</p></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Standard Nunjucks template macros cannot run asyncronous code, including async components. The Apostrophe template <a href="./fragments.html">fragment</a> feature <em>can</em> run async code and is a general purpose replacement for macros in Apostrophe 3.</p></div>',3);function A(C,g,_,w,b,k){const t=c("AposCodeBlock");return p(),r("div",null,[d,n(t,null,{caption:o(()=>[s(" modules/product/index.js ")]),default:o(()=>[y,s()]),_:1}),F,n(t,null,{caption:o(()=>[s(" modules/product/index.js ")]),default:o(()=>[m,s()]),_:1}),D,h,n(t,null,{caption:o(()=>[s(" modules/product/views/newest.html ")]),default:o(()=>[u,s()]),_:1}),f])}const v=a(i,[["render",A]]);export{x as __pageData,v as default};
